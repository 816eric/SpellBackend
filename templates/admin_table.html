<!DOCTYPE html>
<html>
<head>
  <title>Manage {{ table_name }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">
  <h1>üìã {{ table_name }}</h1>
  <a href="/admin" class="btn btn-link">&larr; Back to Tables</a>
  <a href="/admin/table/{{ table_name }}/export" class="btn btn-outline-success float-end">‚¨áÔ∏è Export CSV</a>

  <form method="get" class="input-group mt-3 mb-3" action="">
    <input type="text" name="search" class="form-control" placeholder="Search..." value="{{ search }}">
    <button type="submit" class="btn btn-outline-primary">Search</button>
  </form>

  <form method="post" action="/admin/table/{{ table_name }}/import" enctype="multipart/form-data" class="mb-3">
    <div class="input-group">
      <input type="file" name="file" class="form-control" required>
      <button type="submit" class="btn btn-outline-info">üì§ Import CSV</button>
    </div>
  </form>

  {% if total_pages > 1 %}
  <nav>
    <ul class="pagination">
      {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="?page={{ p }}&search={{ search }}">{{ p }}</a>
        </li>
      {% endfor %}
    </ul>
  </nav>
  {% endif %}


  <h4 class="mt-4">Table Columns</h4>
  <table class="table table-bordered table-sm mb-4">
    <thead>
      <tr>
        <th>Column Name</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for col in columns if col != 'rowid' %}
      <tr>
        <td>{{ col }}</td>
        <td style="white-space: nowrap">
          <form method="post" action="/admin/table/{{ table_name }}/delete_column" style="display:inline;" onsubmit="return confirm('Delete column {{ col }}? This cannot be undone!');">
            <input type="hidden" name="column_name" value="{{ col }}">
            <button type="submit" class="btn btn-sm btn-danger">üóë Delete</button>
          </form>
          <!-- Update column (rename) -->
          <form method="post" action="/execute_query" style="display:inline;">
            <input type="hidden" name="query" value="ALTER TABLE {{ table_name }} RENAME COLUMN {{ col }} TO ">
            <input type="text" name="new_column_name" placeholder="New name" style="width: 100px;">
            <button type="submit" class="btn btn-sm btn-secondary">‚úèÔ∏è Rename</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h5>Add Column</h5>
  <form method="post" action="/admin/table/{{ table_name }}/add_column" class="row g-2 mb-4">
    <div class="col-md-4">
      <input type="text" name="column_name" class="form-control" placeholder="Column Name" required>
    </div>
    <div class="col-md-4">
      <select name="column_type" class="form-select" required>
        <option value="">Type</option>
        <option value="INTEGER">INTEGER</option>
        <option value="TEXT">TEXT</option>
        <option value="REAL">REAL</option>
        <option value="BLOB">BLOB</option>
      </select>
    </div>
    <div class="col-md-4">
      <button type="submit" class="btn btn-success">‚ûï Add Column</button>
    </div>
  </form>

  <table class="table table-bordered table-sm">
    <thead>
      <tr>
        {% for col in columns %}
        <th {% if col in ['filename', 'upper_link', 'id', 'reqDocType'] %}style="width: 40%;"{% endif %}>{{ col }}</th>
        {% endfor %}
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for row in records %}
      <tr>
        <form method="post" action="/admin/table/{{ table_name }}/edit">
          {% for i in range(columns | length) %}
          {% set col = columns[i] %}
          {% set val = row[i] %}
          <td>
            {% if col == 'rowid' %}
              <input type="hidden" name="rowid" value="{{ val }}">
              {{ val }}
            {% else %}
              <input type="text" class="form-control form-control-sm" name="{{ col }}" value="{{ val }}">
            {% endif %}
          </td>
          {% endfor %}
          <td style="white-space: nowrap">
            <button type="submit" class="btn btn-sm btn-warning">üíæ Save</button>
        </form>
        <form method="post" action="/admin/table/{{ table_name }}/delete" style="display:inline;">
          <input type="hidden" name="rowid" value="{{ row[0] }}">
          <button type="submit" class="btn btn-sm btn-danger">üóë Delete</button>
        </form>
          </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if total_pages > 1 %}
  <nav>
    <ul class="pagination">
      {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="?page={{ p }}&search={{ search }}">{{ p }}</a>
        </li>
      {% endfor %}
    </ul>
  </nav>
  {% endif %}

  <h4 class="mt-4">Add New Entry</h4>
  <form method="post" action="/admin/table/{{ table_name }}/add" class="row g-3">
    {% for col in columns if col != 'rowid' %}
    <div class="col-md-4">
      <label class="form-label">{{ col }}</label>
      <input type="text" name="{{ col }}" class="form-control">
    </div>
    {% endfor %}
    <div class="col-12 mt-3">
      <button type="submit" class="btn btn-success">‚ûï Add Row</button>
    </div>
  </form>
</body>
</html>
